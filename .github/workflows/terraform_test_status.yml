# This workflow runs on `pull_request`.
#
# `Terraform Test Status` job retrieves Terraform module test results from HCP Terraform that match
# the repository name. It finds the most recent test with the name of the last commit to the pull request,
# waits for it to complete, and posts the test status as a comment on the pull request.
#
# Documentation
# - https://developer.hashicorp.com/terraform/cloud-docs/api-docs/modules
# - https://developer.hashicorp.com/terraform/cloud-docs/api-docs/test-results

name: Terraform Test Status

on:  # yamllint disable-line rule:truthy
  pull_request:
    branches:
      - '*'                      # matches every branch that doesn't contain a '/'
      - '*/*'                    # matches every branch containing a single '/'
      - '**'                     # matches every branch

permissions:
  contents: read
  pull-requests: write

jobs:
  terraform-test-status:
    name: Terraform Test Status
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TF_CLOUD_TOKEN: ${{ secrets.TFE_TOKEN }}
      TF_CLOUD_ORGANIZATION: benoitblais-hashicorp
    steps:

      - name: Branch
        id: branch
        run: echo "branch=${GITHUB_HEAD_REF}" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.branch.outputs.branch }}

      - name: Get Last Commit Message
        id: commit
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Last commit message: ${COMMIT_MESSAGE}"
          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Last commit SHA: $(git rev-parse HEAD)"
          echo "message=${COMMIT_MESSAGE}" >> "$GITHUB_OUTPUT"
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Get Repository Name
        id: repo
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Repository name: ${REPO_NAME}"
          echo "name=${REPO_NAME}" >> "$GITHUB_OUTPUT"

      - name: Get Test Results
        id: test
        env:
          REPO_NAME: ${{ steps.repo.outputs.name }}
          COMMIT_MESSAGE: ${{ steps.commit.outputs.message }}
          COMMIT_SHA: ${{ steps.commit.outputs.sha }}
        run: |
          # Parse repository name to extract module information
          # Repository follows terraform naming convention: terraform-<provider>-<name>
          # For private registry, namespace is the same as organization

          # Extract provider and name from repository name
          # Format: terraform-<provider>-<name> (e.g., terraform-github-repositories)
          MODULE_NAMESPACE="${TF_CLOUD_ORGANIZATION}"

          # Remove 'terraform-' prefix to get '<provider>-<name>'
          TEMP="${REPO_NAME#terraform-}"

          # Extract provider (first part after terraform-)
          MODULE_PROVIDER="${TEMP%%-*}"

          # Extract name (everything after the provider)
          MODULE_NAME="${TEMP#*-}"

          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Parsed module details from repository name."
          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Repository: ${REPO_NAME}"
          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Namespace: ${MODULE_NAMESPACE}"
          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Provider: ${MODULE_PROVIDER}"
          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Name: ${MODULE_NAME}"

          # Function to check test status
          check_test_status() {
            local test_id=$1
            local response=$(curl -s \
              --header "Authorization: Bearer ${TF_CLOUD_TOKEN}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/organizations/${TF_CLOUD_ORGANIZATION}/tests/registry-modules/private/${MODULE_NAMESPACE}/${MODULE_NAME}/${MODULE_PROVIDER}/test-runs/${test_id}")
            
            # Extract and return only the status
            local status=$(echo "${response}" | jq -r '.data.attributes.status')
            echo "${status}"
          }

          # Function to wait for test completion
          wait_for_test() {
            local test_id=$1
            local max_attempts=60
            local attempt=0

            echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Waiting for test ${test_id} to complete..."

            while [ $attempt -lt $max_attempts ]; do
              status=$(check_test_status "$test_id")

              case "$status" in
                "finished")
                  echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test completed with status: ${status}"
                  return 0
                  ;;
                "pending"|"queued"|"running")
                  echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test is ${status}... (attempt $((attempt + 1))/${max_attempts})"
                  sleep 10
                  ;;
                "errored"|"canceled")
                  echo "WARNING  | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test ended with status: ${status}"
                  return 0
                  ;;
                *)
                  echo "WARNING  | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Unknown status: ${status}"
                  sleep 10
                  ;;
              esac

              attempt=$((attempt + 1))
            done

            echo "ERROR    | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test did not complete within timeout period"
            return 1
          }

          # Get test results for the module using the correct API endpoint
          TEST_RESULTS_URL="https://app.terraform.io/api/v2/organizations/${TF_CLOUD_ORGANIZATION}/tests/registry-modules/private/${MODULE_NAMESPACE}/${MODULE_NAME}/${MODULE_PROVIDER}/test-runs?page%5Bsize%5D=20"

          TEST_RESULTS=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            --header "Authorization: Bearer ${TF_CLOUD_TOKEN}" \
            --header "Content-Type: application/vnd.api+json" \
            "${TEST_RESULTS_URL}")

          HTTP_STATUS=$(echo "${TEST_RESULTS}" | grep "HTTP_STATUS:" | cut -d: -f2)
          TEST_RESULTS=$(echo "${TEST_RESULTS}" | sed '/HTTP_STATUS:/d')

          # Check for 404 error
          if [ "${HTTP_STATUS}" == "404" ]; then
            echo "ERROR    | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test results endpoint returned 404 - module may not exist in private registry"
            {
              echo "status=not_found"
              echo "message=Module not found in private registry: ${MODULE_NAMESPACE}/${MODULE_NAME}/${MODULE_PROVIDER}"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check if data exists
          HAS_DATA=$(echo "${TEST_RESULTS}" | jq -r '.data // empty | length')

          if [ -z "${HAS_DATA}" ] || [ "${HAS_DATA}" == "0" ]; then
            echo "WARNING  | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | No test results found for module: ${REPO_NAME}"
            {
              echo "status=no_tests"
              echo "message=No test results found for module: ${REPO_NAME}"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find the most recent test matching the commit message
          TEST_ID=$(echo "${TEST_RESULTS}" | jq -r --arg commit "${COMMIT_MESSAGE}" \
            '(.data // []) | .[] | select(.attributes.message == $commit) | .id' | head -n 1)

          if [ -z "${TEST_ID}" ]; then
            # If no exact match, get the most recent test
            TEST_ID=$(echo "${TEST_RESULTS}" | jq -r '(.data // [])[0].id // empty')
          fi

          if [ -z "${TEST_ID}" ]; then
            echo "WARNING  | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | No test results found for module: ${REPO_NAME}"
            {
              echo "status=no_tests"
              echo "message=No test results found for module: ${REPO_NAME}"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Found test ID: ${TEST_ID}"
          echo "test_id=${TEST_ID}" >> "$GITHUB_OUTPUT"

          # Wait for test to complete
          if wait_for_test "${TEST_ID}"; then
            # Get detailed test results
            TEST_DETAILS=$(curl -s \
              --header "Authorization: Bearer ${TF_CLOUD_TOKEN}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/organizations/${TF_CLOUD_ORGANIZATION}/tests/registry-modules/private/${MODULE_NAMESPACE}/${MODULE_NAME}/${MODULE_PROVIDER}/test-runs/${TEST_ID}")

            RUN_STATUS=$(echo "${TEST_DETAILS}" | jq -r '.data.attributes.status // "unknown"')
            TEST_STATUS=$(echo "${TEST_DETAILS}" | jq -r '.data.attributes["test-status"] // "unknown"')
            MESSAGE=$(echo "${TEST_DETAILS}" | jq -r '.data.attributes.message // "No message"')
            CREATED_AT=$(echo "${TEST_DETAILS}" | jq -r '.data.attributes["created-at"] // ""')

            # Get detailed test counts
            TESTS_PASSED=$(echo "${TEST_DETAILS}" | jq -r '.data.attributes["tests-passed"] // 0')
            TESTS_FAILED=$(echo "${TEST_DETAILS}" | jq -r '.data.attributes["tests-failed"] // 0')
            TESTS_ERRORED=$(echo "${TEST_DETAILS}" | jq -r '.data.attributes["tests-errored"] // 0')
            TESTS_SKIPPED=$(echo "${TEST_DETAILS}" | jq -r '.data.attributes["tests-skipped"] // 0')
            TESTS_TOTAL=$((TESTS_PASSED + TESTS_FAILED + TESTS_ERRORED + TESTS_SKIPPED))

            echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Run status: ${RUN_STATUS}"
            echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test status: ${TEST_STATUS}"
            echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test message: ${MESSAGE}"
            echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test created at: ${CREATED_AT}"
            echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test counts - Total: ${TESTS_TOTAL}, Passed: ${TESTS_PASSED}, Failed: ${TESTS_FAILED}, Errored: ${TESTS_ERRORED}, Skipped: ${TESTS_SKIPPED}"

            {
              echo "status=${TEST_STATUS}"
              echo "run_status=${RUN_STATUS}"
              echo "message=${MESSAGE}"
              echo "created_at=${CREATED_AT}"
              echo "tests_total=${TESTS_TOTAL}"
              echo "tests_passed=${TESTS_PASSED}"
              echo "tests_failed=${TESTS_FAILED}"
              echo "tests_errored=${TESTS_ERRORED}"
              echo "tests_skipped=${TESTS_SKIPPED}"
            } >> "$GITHUB_OUTPUT"
          else
            echo "ERROR    | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Test timeout"
            {
              echo "status=timeout"
              echo "message=Test did not complete within the timeout period"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR Comment
        if: steps.test.outputs.status != 'not_found' && steps.test.outputs.status != 'no_tests'
        run: |
          # Determine emoji and color based on test-status (pass/fail)
          case "${{ steps.test.outputs.status }}" in
            "pass")
              EMOJI="✅"
              STATUS_TEXT="PASSED"
              COLOR="green"
              ;;
            "fail")
              EMOJI="❌"
              STATUS_TEXT="FAILED"
              COLOR="red"
              ;;
            "timeout")
              EMOJI="⏱️"
              STATUS_TEXT="TIMEOUT"
              COLOR="yellow"
              ;;
            *)
              EMOJI="ℹ️"
              STATUS_TEXT="${{ steps.test.outputs.status }}"
              COLOR="blue"
              ;;
          esac

          # Build comment body with test results table
          COMMENT_BODY="### ${EMOJI} Terraform Test Status: ${STATUS_TEXT}

          **Module:** \`${{ steps.repo.outputs.name }}\`
          **Test ID:** \`${{ steps.test.outputs.test_id }}\`
          **Commit:** \`${{ steps.commit.sha }}\`
          **Message:** ${{ steps.test.outputs.message }}
          **Created:** ${{ steps.test.outputs.created_at }}
          **Run Status:** ${{ steps.test.outputs.run_status }}

          #### Test Results

          | Metric | Count |
          |--------|-------|
          | Total Tests | ${{ steps.test.outputs.tests_total }} |
          | ✅ Passed | ${{ steps.test.outputs.tests_passed }} |
          | ❌ Failed | ${{ steps.test.outputs.tests_failed }} |
          | ⚠️ Errored | ${{ steps.test.outputs.tests_errored }} |
          | ⏭️ Skipped | ${{ steps.test.outputs.tests_skipped }} |

          [View in HCP Terraform](https://app.terraform.io/app/${TF_CLOUD_ORGANIZATION}/registry/modules/private/${TF_CLOUD_ORGANIZATION}/${{ steps.repo.outputs.name }}/tests)
          "

          # Post comment to PR
          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Posting test results comment to PR"
          PR_COMMENTS_URL=$(jq -r ".pull_request.comments_url" "${GITHUB_EVENT_PATH}")

          curl -s -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "${COMMENT_BODY}" '{body: $body}')" \
            "${PR_COMMENTS_URL}"

          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Comment posted successfully"

      - name: Create PR Comment - No Tests Found
        if: steps.test.outputs.status == 'not_found' || steps.test.outputs.status == 'no_tests'
        run: |
          COMMENT_BODY="### ℹ️ Terraform Test Status

          ${{ steps.test.outputs.message }}

          **Repository:** \`${{ steps.repo.outputs.name }}\`
          **Organization:** \`${TF_CLOUD_ORGANIZATION}\`

          No test results were found for this module. Make sure the module is published to the private registry and has test runs configured.
          "

          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Posting no tests found comment to PR"
          PR_COMMENTS_URL=$(jq -r ".pull_request.comments_url" "${GITHUB_EVENT_PATH}")

          curl -s -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "${COMMENT_BODY}" '{body: $body}')" \
            "${PR_COMMENTS_URL}"

          echo "INFO     | $(date -u +"%Y-%m-%dT%H:%M:%SZ") | Comment posted successfully"
